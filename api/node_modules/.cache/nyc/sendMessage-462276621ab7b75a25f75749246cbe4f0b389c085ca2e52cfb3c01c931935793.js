function cov_1fqzwgv604(){var path="C:\\Users\\loco8\\workspace\\eurofirms-bootcamp-202305\\staff\\manuel-david-castillo\\instaflan-fullstack\\api\\logic\\chats-logic\\sendMessage.js";var hash="81898f26fb2be82f4ccbdb2e9120c48cca63fdb3";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"C:\\Users\\loco8\\workspace\\eurofirms-bootcamp-202305\\staff\\manuel-david-castillo\\instaflan-fullstack\\api\\logic\\chats-logic\\sendMessage.js",statementMap:{"0":{start:{line:1,column:23},end:{line:1,column:51}},"1":{start:{line:2,column:37},end:{line:2,column:69}},"2":{start:{line:5,column:4},end:{line:5,column:22}},"3":{start:{line:6,column:4},end:{line:6,column:22}},"4":{start:{line:7,column:4},end:{line:7,column:22}},"5":{start:{line:9,column:4},end:{line:33,column:23}},"6":{start:{line:12,column:12},end:{line:12,column:56}},"7":{start:{line:12,column:23},end:{line:12,column:56}},"8":{start:{line:13,column:12},end:{line:13,column:56}},"9":{start:{line:13,column:23},end:{line:13,column:56}},"10":{start:{line:15,column:28},end:{line:21,column:13}},"11":{start:{line:23,column:12},end:{line:23,column:39}},"12":{start:{line:25,column:12},end:{line:25,column:34}},"13":{start:{line:27,column:12},end:{line:27,column:39}},"14":{start:{line:28,column:26},end:{line:28,column:103}},"15":{start:{line:28,column:61},end:{line:28,column:102}},"16":{start:{line:29,column:12},end:{line:29,column:43}},"17":{start:{line:31,column:12},end:{line:31,column:30}},"18":{start:{line:36,column:0},end:{line:36,column:28}}},fnMap:{"0":{name:"sendMessage",decl:{start:{line:4,column:9},end:{line:4,column:20}},loc:{start:{line:4,column:43},end:{line:34,column:1}},line:4},"1":{name:"(anonymous_1)",decl:{start:{line:11,column:14},end:{line:11,column:15}},loc:{start:{line:11,column:32},end:{line:32,column:9}},line:11},"2":{name:"(anonymous_2)",decl:{start:{line:28,column:51},end:{line:28,column:52}},loc:{start:{line:28,column:61},end:{line:28,column:102}},line:28},"3":{name:"(anonymous_3)",decl:{start:{line:33,column:14},end:{line:33,column:15}},loc:{start:{line:33,column:19},end:{line:33,column:22}},line:33}},branchMap:{"0":{loc:{start:{line:12,column:12},end:{line:12,column:56}},type:"if",locations:[{start:{line:12,column:12},end:{line:12,column:56}},{start:{line:12,column:12},end:{line:12,column:56}}],line:12},"1":{loc:{start:{line:13,column:12},end:{line:13,column:56}},type:"if",locations:[{start:{line:13,column:12},end:{line:13,column:56}},{start:{line:13,column:12},end:{line:13,column:56}}],line:13}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0},f:{"0":0,"1":0,"2":0,"3":0},b:{"0":[0,0],"1":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"81898f26fb2be82f4ccbdb2e9120c48cca63fdb3"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_1fqzwgv604=function(){return actualCoverage;};}return actualCoverage;}cov_1fqzwgv604();const{Chat,User}=(cov_1fqzwgv604().s[0]++,require("../../data/models"));const{validateId,validateText}=(cov_1fqzwgv604().s[1]++,require("../helpers/validators"));function sendMessage(userId,chatId,text){cov_1fqzwgv604().f[0]++;cov_1fqzwgv604().s[2]++;validateId(userId);cov_1fqzwgv604().s[3]++;validateId(chatId);cov_1fqzwgv604().s[4]++;validateText(text);cov_1fqzwgv604().s[5]++;return Promise.all([Chat.findById(chatId,'-__v'),User.findById(userId,'-__v').lean()]).then(([chat,user])=>{cov_1fqzwgv604().f[1]++;cov_1fqzwgv604().s[6]++;if(!chat){cov_1fqzwgv604().b[0][0]++;cov_1fqzwgv604().s[7]++;throw new Error('chat not found');}else{cov_1fqzwgv604().b[0][1]++;}cov_1fqzwgv604().s[8]++;if(!user){cov_1fqzwgv604().b[1][0]++;cov_1fqzwgv604().s[9]++;throw new Error('user not found');}else{cov_1fqzwgv604().b[1][1]++;}const message=(cov_1fqzwgv604().s[10]++,{author:user._id,text:text,date:new Date(),edit:false,delete:false});cov_1fqzwgv604().s[11]++;chat.messages.push(message);cov_1fqzwgv604().s[12]++;chat.date=new Date();cov_1fqzwgv604().s[13]++;chat.unreadFor=chat.users;const index=(cov_1fqzwgv604().s[14]++,chat.unreadFor.findIndex(userId=>{cov_1fqzwgv604().f[2]++;cov_1fqzwgv604().s[15]++;return userId.toString()===user._id.toString();}));cov_1fqzwgv604().s[16]++;chat.unreadFor.splice(index,1);cov_1fqzwgv604().s[17]++;return chat.save();}).then(()=>{cov_1fqzwgv604().f[3]++;});}cov_1fqzwgv604().s[18]++;module.exports=sendMessage;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMWZxendndjYwNCIsImFjdHVhbENvdmVyYWdlIiwiQ2hhdCIsIlVzZXIiLCJzIiwicmVxdWlyZSIsInZhbGlkYXRlSWQiLCJ2YWxpZGF0ZVRleHQiLCJzZW5kTWVzc2FnZSIsInVzZXJJZCIsImNoYXRJZCIsInRleHQiLCJmIiwiUHJvbWlzZSIsImFsbCIsImZpbmRCeUlkIiwibGVhbiIsInRoZW4iLCJjaGF0IiwidXNlciIsImIiLCJFcnJvciIsIm1lc3NhZ2UiLCJhdXRob3IiLCJfaWQiLCJkYXRlIiwiRGF0ZSIsImVkaXQiLCJkZWxldGUiLCJtZXNzYWdlcyIsInB1c2giLCJ1bnJlYWRGb3IiLCJ1c2VycyIsImluZGV4IiwiZmluZEluZGV4IiwidG9TdHJpbmciLCJzcGxpY2UiLCJzYXZlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInNlbmRNZXNzYWdlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgQ2hhdCwgVXNlciB9ID0gcmVxdWlyZShcIi4uLy4uL2RhdGEvbW9kZWxzXCIpO1xyXG5jb25zdCB7IHZhbGlkYXRlSWQsIHZhbGlkYXRlVGV4dCB9ID0gcmVxdWlyZShcIi4uL2hlbHBlcnMvdmFsaWRhdG9yc1wiKTtcclxuXHJcbmZ1bmN0aW9uIHNlbmRNZXNzYWdlKHVzZXJJZCwgY2hhdElkLCB0ZXh0KSB7XHJcbiAgICB2YWxpZGF0ZUlkKHVzZXJJZClcclxuICAgIHZhbGlkYXRlSWQoY2hhdElkKVxyXG4gICAgdmFsaWRhdGVUZXh0KHRleHQpXHJcblxyXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKFtDaGF0LmZpbmRCeUlkKGNoYXRJZCwgJy1fX3YnKSwgXHJcbiAgICAgICAgVXNlci5maW5kQnlJZCh1c2VySWQsICctX192JykubGVhbigpXSlcclxuICAgICAgICAudGhlbigoW2NoYXQsIHVzZXJdKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghY2hhdCkgdGhyb3cgbmV3IEVycm9yKCdjaGF0IG5vdCBmb3VuZCcpXHJcbiAgICAgICAgICAgIGlmICghdXNlcikgdGhyb3cgbmV3IEVycm9yKCd1c2VyIG5vdCBmb3VuZCcpXHJcblxyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0ge1xyXG4gICAgICAgICAgICAgICAgYXV0aG9yOiB1c2VyLl9pZCxcclxuICAgICAgICAgICAgICAgIHRleHQ6IHRleHQsXHJcbiAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgICAgICAgICAgZWRpdDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBkZWxldGU6IGZhbHNlXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNoYXQubWVzc2FnZXMucHVzaChtZXNzYWdlKVxyXG5cclxuICAgICAgICAgICAgY2hhdC5kYXRlID0gbmV3IERhdGUoKVxyXG5cclxuICAgICAgICAgICAgY2hhdC51bnJlYWRGb3IgPSBjaGF0LnVzZXJzXHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gY2hhdC51bnJlYWRGb3IuZmluZEluZGV4KHVzZXJJZCA9PiB1c2VySWQudG9TdHJpbmcoKSA9PT0gdXNlci5faWQudG9TdHJpbmcoKSlcclxuICAgICAgICAgICAgY2hhdC51bnJlYWRGb3Iuc3BsaWNlKGluZGV4LCAxKVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGNoYXQuc2F2ZSgpXHJcbiAgICAgICAgfSlcclxuICAgICAgICAudGhlbigoKT0+IHsgfSlcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBzZW5kTWVzc2FnZSJdLCJtYXBwaW5ncyI6Inc2RkFlWTtBQUFBQSxjQUFBLFNBQUFBLENBQUEsU0FBQUMsY0FBQSxXQUFBQSxjQUFBLEVBQUFELGNBQUEsR0FmWixLQUFNLENBQUVFLElBQUksQ0FBRUMsSUFBSyxDQUFDLEVBQUFILGNBQUEsR0FBQUksQ0FBQSxNQUFHQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsRUFDbkQsS0FBTSxDQUFFQyxVQUFVLENBQUVDLFlBQWEsQ0FBQyxFQUFB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